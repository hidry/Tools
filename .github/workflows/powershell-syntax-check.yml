name: PowerShell Validation

on:
  push:
    branches: ['**']
    paths:
      - '**.ps1'
      - '.github/workflows/powershell-syntax-check.yml'
  pull_request:
    paths:
      - '**.ps1'
      - '.github/workflows/powershell-syntax-check.yml'
  workflow_dispatch:

jobs:
  validate:
    name: Validate PowerShell Scripts
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate PowerShell Scripts Syntax
        shell: pwsh
        run: |
          Write-Host "üîç PowerShell Syntax Validation" -ForegroundColor Cyan
          Write-Host "================================" -ForegroundColor Cyan
          Write-Host ""

          # Find all PowerShell scripts
          $scripts = Get-ChildItem -Path . -Filter *.ps1 -Recurse -File

          if ($scripts.Count -eq 0) {
            Write-Host "‚ö†Ô∏è  No PowerShell scripts found" -ForegroundColor Yellow
            exit 0
          }

          Write-Host "Found $($scripts.Count) PowerShell script(s)" -ForegroundColor White
          Write-Host ""

          $failed = @()
          $passed = 0

          foreach ($script in $scripts) {
            $relativePath = $script.FullName.Replace($PWD.Path + [System.IO.Path]::DirectorySeparatorChar, '')
            Write-Host "Checking: $relativePath" -ForegroundColor Cyan

            $errors = $null
            $tokens = $null

            try {
              $ast = [System.Management.Automation.Language.Parser]::ParseFile(
                $script.FullName,
                [ref]$tokens,
                [ref]$errors
              )

              if ($errors -and $errors.Count -gt 0) {
                Write-Host "  ‚ùå SYNTAX ERROR" -ForegroundColor Red
                foreach ($error in $errors) {
                  Write-Host "     Line $($error.Extent.StartLineNumber): $($error.Message)" -ForegroundColor Red
                }
                $failed += @{
                  Script = $relativePath
                  Errors = $errors
                }
              } else {
                Write-Host "  ‚úÖ Valid" -ForegroundColor Green
                $passed++
              }
            } catch {
              Write-Host "  ‚ùå PARSE FAILED: $_" -ForegroundColor Red
              $failed += @{
                Script = $relativePath
                Errors = @("Exception: $_")
              }
            }
            Write-Host ""
          }

          # Summary
          Write-Host "================================" -ForegroundColor Cyan
          Write-Host "Summary:" -ForegroundColor Cyan
          Write-Host "  ‚úÖ Passed: $passed" -ForegroundColor Green
          Write-Host "  ‚ùå Failed: $($failed.Count)" -ForegroundColor $(if ($failed.Count -gt 0) { 'Red' } else { 'Gray' })
          Write-Host "================================" -ForegroundColor Cyan

          if ($failed.Count -gt 0) {
            Write-Host ""
            Write-Host "‚ùå Syntax validation failed for:" -ForegroundColor Red
            foreach ($f in $failed) {
              Write-Host "  - $($f.Script)" -ForegroundColor Red
            }
            exit 1
          } else {
            Write-Host ""
            Write-Host "‚úÖ All PowerShell scripts have valid syntax!" -ForegroundColor Green
          }

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Write-Host "üì¶ Installing PSScriptAnalyzer..." -ForegroundColor Cyan
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -SkipPublisherCheck
          Write-Host "‚úÖ PSScriptAnalyzer installed" -ForegroundColor Green

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "üîç PSScriptAnalyzer - Code Quality Check" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""

          # Find all PowerShell scripts
          $scripts = Get-ChildItem -Path . -Filter *.ps1 -Recurse -File

          if ($scripts.Count -eq 0) {
            Write-Host "‚ö†Ô∏è  No PowerShell scripts found" -ForegroundColor Yellow
            exit 0
          }

          Write-Host "Analyzing $($scripts.Count) PowerShell script(s)" -ForegroundColor White
          Write-Host ""

          $totalErrors = 0
          $totalWarnings = 0
          $totalInfo = 0
          $scriptsWithErrors = @()

          foreach ($script in $scripts) {
            $relativePath = $script.FullName.Replace($PWD.Path + [System.IO.Path]::DirectorySeparatorChar, '')
            Write-Host "Analyzing: $relativePath" -ForegroundColor Cyan

            $results = Invoke-ScriptAnalyzer -Path $script.FullName -Severity Error,Warning,Information

            if ($results) {
              $errors = @($results | Where-Object { $_.Severity -eq 'Error' })
              $warnings = @($results | Where-Object { $_.Severity -eq 'Warning' })
              $info = @($results | Where-Object { $_.Severity -eq 'Information' })

              if ($errors.Count -gt 0) {
                Write-Host "  ‚ùå $($errors.Count) Error(s)" -ForegroundColor Red
                $scriptsWithErrors += $relativePath
                foreach ($error in $errors) {
                  Write-Host "     [ERROR] Line $($error.Line): $($error.RuleName)" -ForegroundColor Red
                  Write-Host "             $($error.Message)" -ForegroundColor Red
                }
              }

              if ($warnings.Count -gt 0) {
                Write-Host "  ‚ö†Ô∏è  $($warnings.Count) Warning(s)" -ForegroundColor Yellow
                foreach ($warning in $warnings) {
                  Write-Host "     [WARN] Line $($warning.Line): $($warning.RuleName)" -ForegroundColor Yellow
                  Write-Host "            $($warning.Message)" -ForegroundColor Gray
                }
              }

              if ($info.Count -gt 0) {
                Write-Host "  ‚ÑπÔ∏è  $($info.Count) Info(s)" -ForegroundColor Gray
              }

              $totalErrors += $errors.Count
              $totalWarnings += $warnings.Count
              $totalInfo += $info.Count

            } else {
              Write-Host "  ‚úÖ No issues found" -ForegroundColor Green
            }
            Write-Host ""
          }

          # Summary
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Summary:" -ForegroundColor Cyan
          Write-Host "  ‚ùå Errors: $totalErrors" -ForegroundColor $(if ($totalErrors -gt 0) { 'Red' } else { 'Green' })
          Write-Host "  ‚ö†Ô∏è  Warnings: $totalWarnings" -ForegroundColor $(if ($totalWarnings -gt 0) { 'Yellow' } else { 'Gray' })
          Write-Host "  ‚ÑπÔ∏è  Info: $totalInfo" -ForegroundColor Gray
          Write-Host "========================================" -ForegroundColor Cyan

          if ($totalErrors -gt 0) {
            Write-Host ""
            Write-Host "‚ùå PSScriptAnalyzer found errors in:" -ForegroundColor Red
            foreach ($s in $scriptsWithErrors) {
              Write-Host "  - $s" -ForegroundColor Red
            }
            Write-Host ""
            Write-Host "Please fix the errors before merging." -ForegroundColor Yellow
            exit 1
          } else {
            Write-Host ""
            if ($totalWarnings -gt 0) {
              Write-Host "‚úÖ No errors found, but there are warnings to review." -ForegroundColor Yellow
            } else {
              Write-Host "‚úÖ All PowerShell scripts passed analysis!" -ForegroundColor Green
            }
            exit 0
          }
